# 양방향 연관관계

### 객체(JPA)와 테이블(DB)의 연관관계를 맺는 차이
- 객체(JPA)는 **2개의 단방향 연관관계**로 양방향 연관관계를 표현한다.
- 테이블(DB)은 **1개의 양방향 연관관계**로 양방향 연관관계를 표현한다.
    - 외래키 하나로 두 양쪽으로 조인할 수 있기떄문
- 이때, JPA에선 하나의 테이블레코드에 참조하는 두개의 객체 필드가 생기게 되는데 어느 필드 사용했을때 DB를 관리할 것인가에 대한 딜레마가 생기게됨
- 그래서, **객체의 양방향 연관관계는 관리의 주인이 필요**

### 연관관계의 주인
- 연관관계의 주인만이 외래키를 관리, 주인이 아닌쪽은 읽기만 가능
- 주인은 `mappdeBy`속성 사용 X, 주인이 아니면 `mappedBy`속성으로 주인 지정
### 누구를 연관관계의 주인으로 해야할까
- 연관관계의 주인은 외래키가 있는 곳, 1:N일때 N쪽
  - -> 무조건 적인 것은 아니지만 생각해보면 Board Entity를 이용해서 Comment Table에 접근하는 것이 좋아보이지 않고 이해하기도 어려울 수 있다.
- 외래키가 있는 쪽(주인)은 테이블과 연결(`joincolumn`)하고 없는 쪽(주인의 반대)은 `mappedBy`
### 주의점
- 주인이 아닌 Entity의 필드로 주인인 Entity를 관리하려고 하면 안된다.
  - 생각한대로 값이 추가되지않음 
    - ex, board의 comments로 comment를 추가하면 comment Entity를 사용해서 추가할때 사용되는 
    `@GeneratedValue(strategy = GenerationType.IDENTITY)` 가 적용되지 않음
  - **객체지향 시점으로는 주인과 주인아닌 Entity 모두에 값을 추가하는 것이 맞다**
    - 주인 Entity로만 추가하게면 순수자바코드로 Test할때 맞지 않음
    - 그렇다고 서비스에 같은 Entity를 두번 추가하는 로직을 만드냐? NO
      - -> 편의(헬퍼) 메소드 작성(`addComment`)
- 편의 메서드(헬퍼 메서드)
  - 편의 메서드는 주인Entity, 주인아닌Entity 어느쪽에 만들던 상관없다
    - 양쪽에 만들지만 않으면됨
  - 헬퍼메서드 주의점
    1. 양쪽에 메서드를 만들시 무한루프 가능성
    2. toString, lombok 사용시 무한루프가능성
    3. JSON 생성 라이브러리 사용시 무한루프 가능성 -> `controller` 에서 `Entity`를 그대로 보내는 경우

> `controller`에서 `Entity`를 반환하면 안되는 두가지 이유
> 1. 양방향 연관관계 사용시 JSON으로 변환하는 과정에서 무한루프 가능성 있음
> 2. Entity 변경시(필드 추가/제거) API응답까지 바뀌게 됨
> 
> 결론: DTO 쓰자, 실무에선 거의 Entity 반환 안한다!

### 양방향 연관관계 결론
- 단방향 매핑만으로도 이미 연관관계 매핑은 끝난다. -> 설계시에는 단방향만으로 설계를 한다.
- 양방향 매핑은 개발 단계에 필요시에 하면됨 -> 실제로 역방향으로 참조할 일이 많다고 한다.
  - 그래도 테이블에 영향은 주지 않음
- 연관관계의 주인은 외래 키가 있는 곳으로 하자





















































